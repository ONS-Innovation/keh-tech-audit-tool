{% extends "core.html" %}
{% from "components/button/_macro.njk" import onsButton %}
{% from "components/radios/_macro.njk" import onsRadios %}
{% from "components/question/_macro.njk" import onsQuestion %}
{% from "components/accordion/_macro.njk" import onsAccordion %}
{% from "components/label/_macro.njk" import onsLabel %}
{% block main %}
    <h1>Developed</h1>
    {{ onsAccordion({
        "id": "accordion-example",
        "itemsList": [
            {
                "title": "More info",
                "content": "<p>Enter details about whether the project was developed in-house, outsourced or in partnership with another company.</p>"
            }
        ]
    }) }}
    <form action="{{ url_for('survey') }}" method="GET">
        {{ onsLabel({
    "id": 'developed-label',
    "for": "developed",
    "text": 'Where was this Software Developed?',
    "description": 'Select the option that best describes how the project was developed.'
}) }}
        {% call onsQuestion({
        "classes": "ons-u-mt-no",
        "legendIsQuestionTitle": true
    }) %}
        {{ onsRadios({
            "dontWrap": true,
            "name": "developed",
            "radios": [
                {
                    "id": "in-house",
                    "label": {
                        "text": "In House"
                    },
                    "value": "In House"
                },
                {
                    "id": "outsourced",
                    "label": {
                        "text": "Outsourced"
                    },
                    "value": "outsourced",
                    "value": "Outsourced",
                    "other": {
                        "id": "outsourced",
                        "name": "other",
                        "label": {
                            "text": "Outsource Company"
                        }
                    }
                },
                {
                    "id": "partnership",
                    "label": {
                        "text": "Partnership"
                    },
                    "value": "Partnership",
                    "other": {
                        "id": "partnership",
                        "name": "other",
                        "label": {
                            "text": "Partnership Company"
                        }
                    }
                }
            ]
        }) }}
        {% endcall %}
        <script src="{{ url_for('static', filename='formScripts.js') }}"></script>
        {{ onsButton({
        "id": "save-values-button",
        "url": url_for('stage'),
        "text": "Save and continue",
        "attributes": {
            "onclick": "storeData();"
        }
    }) }}
        <script>
            // Call redirectToPrevious to set up the return path
            redirectToPrevious();
            
            function storeData() {
                // Get the selected radio button
                const selectedRadio = document.querySelector('input[name="developed"]:checked');
                if (!selectedRadio) return;

                const developed = selectedRadio.value;
                let companyName = '';

                // Get company name based on selection
                if (developed === "Outsourced" || developed === "Partnership") {
                    // Find the other-wrap element that's expanded (aria-expanded="true")
                    const otherWraps = document.querySelectorAll('.ons-radio__other');
                    for (const wrap of otherWraps) {
                        if (wrap.parentNode.querySelector('input:checked')) {
                            const input = wrap.querySelector('input[type="text"]');
                            if (input) {
                                companyName = input.value;
                                break;
                            }
                        }
                    }
                }

                console.log(`Saving developed: ${developed}, company: ${companyName}`);

                // Create data array
                const data = [developed];
                if (developed !== "In House") {
                    data.push(companyName);
                }

                // Determine storage key based on edit mode
                const storageKey = JSON.parse(localStorage.getItem('edit')) ? 
                    'developed-data-edit' : 'developed-data';

                // Store in localStorage
                localStorage.setItem(storageKey, JSON.stringify(data));
            }

            function loadData() {
                const mapping = {
                    "Outsourced": "outsourced",
                    "Partnership": "partnership",
                    "In House": "in-house"
                };

                // Get data from localStorage
                const storageKey = JSON.parse(localStorage.getItem('edit')) ? 
                    'developed-data-edit' : 'developed-data';
                const data = JSON.parse(localStorage.getItem(storageKey));

                if (!data) return;

                try {
                    // Handle both array and object formats
                    if (Array.isArray(data)) {
                        const radioId = mapping[data[0]];
                        if (radioId) {
                            document.getElementById(radioId).checked = true;
                            
                            // Set company name if applicable
                            if (data[0] === "Outsourced" || data[0] === "Partnership") {
                                // Trigger the "other" field to show
                                const radioInput = document.getElementById(radioId);
                                if (radioInput) {
                                    // Force the "other" field to expand
                                    const otherWrap = document.getElementById(`${radioId}-other-wrap`);
                                    if (otherWrap) {
                                        otherWrap.style.display = 'block';
                                        const input = otherWrap.querySelector('input[type="text"]');
                                        if (input) {
                                            input.value = data[1] || "";
                                        }
                                    }
                                }
                            }
                        }
                    } else if (data.developed) {
                        // Legacy object format
                        const radioId = mapping[data.developed];
                        if (radioId) {
                            document.getElementById(radioId).checked = true;
                            
                            if (data.developed === "Outsourced" || data.developed === "Partnership") {
                                // Trigger the "other" field to show
                                const radioInput = document.getElementById(radioId);
                                if (radioInput) {
                                    // Force the "other" field to expand
                                    const otherWrap = document.getElementById(`${radioId}-other-wrap`);
                                    if (otherWrap) {
                                        otherWrap.style.display = 'block';
                                        const input = otherWrap.querySelector('input[type="text"]');
                                        if (input) {
                                            input.value = data.developed === "Outsourced" ? 
                                                data.outsource_company || "" : 
                                                data.partnership_company || "";
                                        }
                                    }
                                }
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error loading developed data:', e);
                }
            }

            // Initialize page
            document.addEventListener('DOMContentLoaded', function() {
                loadData();
            });
        </script>
    </form>
{% endblock %}