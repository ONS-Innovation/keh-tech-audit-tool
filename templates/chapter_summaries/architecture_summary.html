{% extends "layout/_template.njk" %}
{% from "components/summary/_macro.njk" import onsSummary %}
{% from "components/panel/_macro.njk" import onsPanel %}
{% from "components/label/_macro.njk" import onsLabel %}
{% from "components/button/_macro.njk" import onsButton %}
{% set pageConfig = {
        "header": {
            "title": "Create a project",
            "signoutButton": {
                "text": "Save and sign out"
            }
        },
              "footer": {
          "OGLLink": {
              "pre": "All content is available under the", "link": "Open Government Licence v3.0",
              "url": "https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/",
              "post": ", except where otherwise stated"
          }
      }
    } %}
{% block main %}
    {% call onsPanel({
        "id": "error-panel",
        "title": 'Error',
        "variant": 'error',
        "type": "error",
        "classes": "ons-u-hidden"
    }) %}
    {{ onsLabel({
        "id": 'error-label',
        "for": "error-label",
        "text": 'Please fill in missing data'
    }) }}
    {% endcall %}
    <h1 class="ons-u-mt-m">Code and Architecture Summary</h1>
    {{ onsSummary({
            "variant": "hub",
            "classes": "ons-u-mt-m",
            "summaries": [
                {
                    "groups": [
                        {
                            "rows": [
                                {
                                    "rowTitle": "Source Control",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                                {
                                                    "text": "<div id='source_control_details'></div>"
                                                }
                                            ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for People who live here",
                                                    "url": url_for('source_control'),
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Hosting",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='hosting_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for Household accommodation",
                                                    "url": url_for('hosting')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Database",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='database_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for Mary Smith",
                                                    "url": url_for('database')
                                                }
                                            ]
                                        }
                                    ]
                                },
 
                            ]
                        }
                    ]
                }
            ]
        }) }}
    <input id="user" type="hidden" name="user">
        <input id="project" type="hidden" name="project">
            <input id="developed" type="hidden" name="developed">
                {{ onsButton({
            "text": 'Finish section',
            "id": "submit-button",
            "url": url_for('survey'),
            "classes": 'ons-u-mb-m ons-u-mt-l',
            "iconType": "check",
            "iconPosition": "after"
        }) }}
                <script>
                    function arrToList(arr) {
                        var final = ""
                        try {
                            for (let i = 0; i <= arr.length - 1; i++) {
                                if (i === 0) {
                                    final += `<ul>`
                                }
                                final += `<li>${
                                    arr[i]
                                }</li>`;
                                if (i === arr.length - 1) {
                                    final += `</ul>`
                                }
                            }
                        } catch (e) {
                            console.log(e);
                        }
                        return final;
                    }
                    function arrToLinkList(arr) {
                        var final = ""
                        try {
                            for (let i = 0; i <= arr.length - 1; i++) {
                                if (i === 0) {
                                    final += `<ul>`
                                }
                                final += `<li>${
                                    arr[i].description
                                }: <br> <a href='${
                                    arr[i].link
                                }'>${
                                    arr[i].link
                                }</a></li>`;
                                if (i === arr.length - 1) {
                                    final += `</ul>`
                                }
                            }
                        } catch (e) {
                            console.log(e);
                        }
                        return final;
                    }
                    function load_data() {
                        var errorPanel = document.getElementById('error-panel');
                        console.log(errorPanel);
                        var sourceControlData = localStorage.getItem('source_control-data');
                        var hostingData = localStorage.getItem('hosting-data');
                        var databaseData = localStorage.getItem('database-data');
                        var hostingJSON = JSON.parse(hostingData);
                        try {
                            if (hostingJSON.type === 'Hybrid' || hostingJSON.type === 'Cloud') {
                                if (hostingJSON.others.length === 0) {
                                    errorPanel.classList.remove('ons-u-hidden');
                                    document
                                        .getElementById('submit-button')
                                        .style
                                        .display = 'none';
                                }
                            }
                            if (sourceControlData === null || JSON.parse(databaseData).length === 0 || hostingJSON.type === null) {
                                errorPanel.classList.remove('ons-u-hidden');
                                document
                                    .getElementById('submit-button')
                                    .style
                                    .display = 'none';
                            }
                        } catch (e) {
                            console
                                .log(e)
                                errorPanel
                                .classList
                                .remove('ons-u-hidden');
                            document
                                .getElementById('submit-button')
                                .style
                                .display = 'none';
                        }
                        var errorList = []
                        try {
                            var sourceControlDataJSON = JSON.parse(sourceControlData);
                            var sourceType = sourceControlDataJSON.source_control;
                            var source_control_links_label = 'No links added to project.';
                            if (sourceControlDataJSON.links && sourceControlDataJSON.links.length > 0) {
                                source_control_links_label = sourceControlDataJSON.links.length > 1
                                    ? 'Links: '
                                    : 'Link: ';
                            }
                            var source_control = `Type: ${sourceType}<br>${source_control_links_label}` + arrToLinkList(sourceControlDataJSON.links);
                            document.getElementById('source_control_details').innerHTML = source_control;
                        } catch (e) {
                            errorList.push('Source Control');
                        }
                        try {
                            var databaseDataJSON = JSON.parse(databaseData);
                            var database_details = arrToList(databaseDataJSON.others);
                            document.getElementById('database_details').innerHTML = database_details;
                        } catch (e) {
                            errorList.push('Database');
                        }
                        try {
                            var hosting_details = `Type: ${
                                hostingJSON.type
                            }`;
                            if (hostingJSON.others && hostingJSON.others.length > 0) {
                                hosting_details += `<br>Services:` + arrToList(hostingJSON.others);
                            }
                            document.getElementById('hosting_details').innerHTML = hosting_details;
                        } catch (e) {
                            errorList.push('Hosting');
                        }
                        if (errorList.length > 0) {
                            errorPanel.classList.remove('ons-u-hidden');
                            document.getElementById('error-label').innerHTML = 'Please fill in the following sections: ' + errorList.join(', ');
                        }
                    }
                    load_data();
                </script>
            {% endblock %}
            {% block scripts %}
                <style>
                    body {
                        height: auto;
                    }
                </style>
            {% endblock %}