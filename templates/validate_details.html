{% extends "core.html" %}
{% from "components/summary/_macro.njk" import onsSummary %}
{% from "components/panel/_macro.njk" import onsPanel %}
{% from "components/label/_macro.njk" import onsLabel %}
{% from "components/button/_macro.njk" import onsButton %}
{% from "components/breadcrumbs/_macro.njk" import onsBreadcrumbs %}

{% block main %}
    {% call onsPanel({
        "id": "error-panel",
        "title": 'Error',
        "variant": 'error',
        "type": "error",
    }) %}


    {{ onsLabel({
        "id": 'label',
        "for": "some-input",
        "text": 'Please fill in missing data'
    }) }}
    {% endcall %}
    {% if edit %}
    {{ onsBreadcrumbs({
        "ariaLabel": 'Breadcrumbs',
        "itemsList": [
            {
                "url": url_for("view_project", project_name=project.details[0].name),
                "text": 'Back'
            },
        ],
    }) }}
    {% endif %}
    <h1 class="ons-u-mt-m">Check your answers</h1>
    {{ onsLabel({
        "id": 'label',
        "for": "some-input",
        "text": 'Please review the information you have entered before submitting the project.',
    }) }}
    {{ onsSummary({
            "variant": "hub",
            "classes": "ons-u-mt-m",
            "summaries": [
                {
                    "groups": [
                        {
                            "rows": [
                                {
                                    "rowTitle": "Technical Contact",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                                {
                                                    "text": "<div id='technical_contact'></div>"
                                                }
                                            ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for People who live here",
                                                    "url": url_for('contact_tech'),
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Delivery Manager Contact",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                                {
                                                    "text": "<div id='delivery_manager'></div>"
                                                }
                                            ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for People who live here",
                                                    "url": url_for('contact_manager'),
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Project",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='project_details'></div>"
                                            }
                                        ],

                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for Household accommodation",
                                                    "url": url_for('project')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Stage",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='stage_details'></div>"
                                            }
                                        ],

                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for Household accommodation",
                                                    "url": url_for('stage')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Developed",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='developed_details'></div>"
                                            }
                                        ],

                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for Mary Smith",
                                                    "url": url_for('developed')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Source Control",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='source_control_details'></div>"
                                            }
                                        ],

                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Continue with John Smith's section",
                                                    "url": url_for('source_control')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Hosting",
                                    "rowItems": [
                                        {
                                        "valueList": [
                                            {
                                                "text": "<div id='hosting_details'></div>"
                                            }
                                        ],

                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Start Billy Smith's section",
                                                    "url": url_for('hosting')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Database",
                                    "rowItems": [
                                        {
                                        "valueList": [
                                            {
                                                "text": "<div id='database_details'></div>"
                                            }
                                        ],

                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Start Mary Susannah Smith's section",
                                                    "url": url_for('database')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Languages",
                                    "rowItems": [
                                        {
                                        "valueList": [
                                            {
                                                "text": "<div id='languages_details'></div>"
                                            }
                                        ],

                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Start Billy Smith's section",
                                                    "url": url_for('languages')                                              }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Frameworks",
                                    "rowItems": [
                                        {
                                        "valueList": [
                                            {
                                                "text": "<div id='framework_details'></div>"
                                            }
                                        ],

                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Start Billy Smith's section",
                                                    "url": url_for('frameworks')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "CI/CD",
                                    "rowItems": [
                                        {
                                        "valueList": [
                                            {
                                                "text": "<div id='integration_details'></div>"
                                            }
                                        ],
                              
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Start Billy Smith's section",
                                                    "url": url_for('integrations')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Infrastructure",
                                    "rowItems": [
                                        {   
                                        "valueList": [
                                            {
                                                "text": "<div id='infrastructure_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Start Billy Smith's section",
                                                    "url": url_for('infrastructure')
                                                }
                                            ]
                                        }
                                    ]
                                },

                                {
                                    "rowTitle": "Code Editors",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                                {
                                                    "text": "<div id='code_editor_details'></div>"
                                                }
                                            ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for People who live here",
                                                    "url": url_for('code_editors'),
                                                }
                                            ]
                                        }
                                    ]
                                },

                                {
                                    "rowTitle": "User Interface",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='user_interface_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for Household accommodation",
                                                    "url": url_for('user_interface')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Diagrams",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='diagram_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for Mary Smith",
                                                    "url": url_for('diagramming_tools')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Project Tracking",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='project_tracking_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for Mary Smith",
                                                    "url": url_for('project_tracking')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Documentation",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='documentation_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for Mary Smith",
                                                    "url": url_for('documentation')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Communication",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='communication_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for Mary Smith",
                                                    "url": url_for('communication')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Collaboration",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='collaboration_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for Mary Smith",
                                                    "url": url_for('collaboration')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Incident Management",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='incident_management_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for Mary Smith",
                                                    "url": url_for('incident_management')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                
                                
                            ]
                        }
                    ]
                }
            ]
        }) }}
    <!--onsubmit="localStorage.clear()"-->
    {% if edit %}
        <form action="{{ url_for('survey') }}" method="POST" onsubmit="localStorage.clear()">
    {% else %}
    <form action="{{ url_for('survey') }}" method="POST" onsubmit="localStorage.clear()">
    {% endif %}

        <input id="user" type="hidden" name="user">
            <input id="project" type="hidden" name="project">
                <input id="developed" type="hidden" name="developed">
                    <input id="source_control" type="hidden" name="source_control">
                        <input id="hosting" type="hidden" name="hosting">
                            <input id="database" type="hidden" name="database">
                                <input id="languages" type="hidden" name="languages">
                                    <input id="frameworks" type="hidden" name="frameworks">
                        <input id="integrations" type="hidden" name="integrations">
                            <input id="infrastructure" type="hidden" name="infrastructure">
                                <input id="stage" type="hidden" name="stage">
                                    <input id="code_editors" type="hidden" name="code_editors">
                                        <input id="user_interface" type="hidden" name="user_interface">
                                            <input id="diagrams" type="hidden" name="diagrams">
                                                <input id="project_tracking" type="hidden" name="project_tracking">
                                                    <input id="documentation" type="hidden" name="documentation">
                                                        <input id="communication" type="hidden" name="communication">
                                                            <input id="collaboration" type="hidden" name="collaboration">
                                                                <input id="incident_management" type="hidden" name="incident_management">
                                                                <input id="project_name" type="hidden" name="project_name">
    {{ onsButton({
            "text": 'Save Project',
            "id": "submit-button",
            "classes": 'ons-u-mb-m ons-u-mt-l',
            "iconType": "check",
            "iconPosition": "after",
        })
    }}
    
</form>
<script src="{{ url_for('static', filename='formScripts.js') }}"></script>
    <script>
            localStorage.setItem('redirect_url', window.location.href);
            var current_url = window.location.href.split("/");
            var trail = current_url[current_url.length - 1];
            var edit = false;
            if (trail === "edit") {
                edit = true;
            }

            localStorage.setItem("edit", edit)
            
            var fields = ['contact_tech-data', 'contact_manager-data', 'project-data', 'developed-data', 'stage-data', 
            'source_control-data', 'hosting-data', 'database-data', 'frameworks-data', 'infrastructure-data', 'integrations-data', 
            'languages-data', 'code_editors-data', 'user_interface-data', 'diagrams-data', 'project_tracking-data', 'documentation-data', 
            'communication-data', 'collaboration-data', 'incident_management-data'];

            if (edit) {
                for (let i = 0; i < fields.length; i++) {
                    fields[i] = fields[i] + '-edit'
                }
            }

        function displayError(message) {
            const errorPanel = document.getElementById('error-panel');
            // Show the error panel
            errorPanel.style.display = 'block';
            
            // Find or create the error message container
            let errorContainer = errorPanel.querySelector('.error-messages');
            if (!errorContainer) {
                errorContainer = document.createElement('div');
                errorContainer.className = 'error-messages';
                // Add after the label but before any existing content
                const label = errorPanel.querySelector('label');
                if (label) {
                    label.insertAdjacentElement('afterend', errorContainer);
                } else {
                    errorPanel.appendChild(errorContainer);
                }
            }
            
            // Add the new error message
            errorContainer.innerHTML += `<ul><li>${message}</li></ul>`;
            document.getElementById('submit-button').style.display = 'none';
        }

        function clearErrors() {
            const errorPanel = document.getElementById('error-panel');
            // Hide the panel
            errorPanel.style.display = 'none';
            // Clear only the error messages, not the header or label
            const errorContainer = errorPanel.querySelector('.error-messages');
            if (errorContainer) {
                errorContainer.innerHTML = '';
            }
            document.getElementById('submit-button').style.display = 'block';
        }

        function validateData(data, sectionName, requiredFields = []) {
            try {
                const parsedData = JSON.parse(data);
                
                // Check if any required fields are missing or empty strings
                for (const field of requiredFields) {
                    if (!parsedData[field] || parsedData[field] === "") {
                        throw new Error(`Missing required field: ${field}`);
                    }
                }

                // Special validation for arrays-based data
                if (sectionName === 'Frameworks' || sectionName === 'Languages' || 
                    sectionName === 'CI/CD' || sectionName === 'Infrastructure' || 
                    sectionName === 'Databases' || sectionName === 'Code Editors' || 
                    sectionName === 'User Interface' || sectionName === 'Diagrams' || sectionName === 'Documentation' || 
                    sectionName === 'Communication' || sectionName === 'Collaboration') {
                    
                    // Check main array - ensure no empty strings
                    const validMain = parsedData.main?.filter(item => item && item !== "");
                    // Check others array - ensure no empty strings
                    const validOthers = parsedData.others?.filter(item => item && item !== "");
                    
                    if ((!validMain || validMain.length === 0) && 
                        (!validOthers || validOthers.length === 0)) {
                        throw new Error(`No items selected in ${sectionName}`);
                    }
                }
                
                return parsedData;
            } catch (e) {
                displayError(`'${sectionName}' section is incomplete`);
                return null;
            }
        }

        function arrToList(arr) {
            if (!arr || arr.length === 0) return '';
            return `<ul>${arr.map(item => `<li>${item}</li>`).join('')}</ul>`;
        }

        function processSourceControl(sourceControlData) {
            const parsed = validateData(sourceControlData, 'Source Control', ['source_control']);
            if (!parsed) return '';

            const finalSourceControl = [{
                type: parsed.source_control,
                links: parsed.links || []
            }];

            let details = `<ul><li>Type: ${finalSourceControl[0].type}</li>`;
            if (finalSourceControl[0].links) {
                finalSourceControl[0].links.forEach(link => {
                    details += `<li>${link.description}: ${link.url}</li>`;
                });
            }
            details += '</ul>';
            
            return details;
        }

        function processHosting(hostingData) {
            const parsed = validateData(hostingData, 'Hosting', ['type']);
            if (!parsed) return '';

            if (parsed.type === "On-premises") {
                return "<ul><li>On-Premises</li></ul>";
            }

            if ((parsed.type === "Cloud" || parsed.type === "Hybrid") && (!parsed.others || parsed.others.length === 0)) {
                displayError("'Hosting' section is incomplete");
                return '';
            }

            return arrToList(parsed.main ? parsed.main.concat(parsed.others) : parsed.others);
        }

        function processProjectTracking(projectTrackingData) {
            const parsed = validateData(projectTrackingData, 'Project Tracking', ['project_tracking']);
            if (!parsed) return '';

            return parsed;
        }

        function processIncidentManagement(incidentManagementData) {
            const parsed = validateData(incidentManagementData, 'Incident Management', ['incident_management']);
            if (!parsed) return '';

            return parsed;
        }

        function processContacts(techData, managerData) {
            const youData = [];
            
            // Process Technical Contact
            const techContact = validateData(techData, 'Technical Contact', ['contactEmail', 'role']);
            if (techContact) {
                youData.push({
                    email: techContact.contactEmail,
                    roles: ["Technical Contact"],
                    grade: techContact.role
                });
            } else {
                youData.push({ email: "", roles: [""], grade: "" });
            }

            // Process Delivery Manager
            const managerContact = validateData(managerData, 'Delivery Manager', ['contactEmail', 'role']);
            if (managerContact) {
                youData.push({
                    email: managerContact.contactEmail,
                    roles: ["Delivery Manager"],
                    grade: managerContact.role
                });
            } else {
                youData.push({ email: "", roles: [""], grade: "" });
            }

            return youData;
        }

        function api_to_ui(api_data) {

            // Convert technical contact/manager data from API to UI schema
            for (let i = 0; i < 2; i++) {
                api_data.user[i]["role"] = api_data.user[i]["grade"];
                delete api_data.user[i]["grade"];
                delete api_data.user[i]["roles"];

                api_data.user[i]["contactEmail"] = api_data.user[i]["email"];
                delete api_data.user[i]["email"];
            }

            // Convert project data from API to UI schema
            var project_fields = ["project_name", "project_short_name", "doc_link"];
    
            api_data.details[0]["project_name"] = api_data.details[0]["name"];
            api_data.details[0]["project_short_name"] = api_data.details[0]["short_name"];
            api_data.details[0]["doc_link"] = api_data.details[0]["documentation_link"][0];
            delete api_data.details[0]["name"];
            delete api_data.details[0]["short_name"];
            delete api_data.details[0]["documentation_link"];


            var new_source_control = {
                "source_control": api_data["source_control"][0]["type"],
                "links": api_data["source_control"][0]["links"]
            }

            api_data["architecture"]["hosting"]["type"] = api_data["architecture"]["hosting"]["type"][0]
            api_data["architecture"]["hosting"]["main"] = []
            api_data["architecture"]["hosting"]["others"] = api_data["architecture"]["hosting"]["details"]
            delete api_data["architecture"]["hosting"]["details"]

            var developed = api_data["developed"][0];
            var partnership_company = null;
            var outsource_company = null;

            if (developed === "Partnership") {
                partnership_company = api_data["developed"][1][0];
            } else if (developed === "Outsourced") {
                outsource_company = api_data["developed"][1][0];
            } else {
                partnership_company = null;
                outsource_company = null;
            }
            var new_developed_data = {
                "developed": developed,
                "outsource_company": outsource_company,
                "partnership_company": partnership_company,
            }
            // {"outsource_company":null,"partnership_company":null,"developed":"In House","complete":true}
            // i'll do this developed shit later

            var architecture = [
                            "database", "languages", "frameworks", "cicd", 
                            "infrastructure"
                        ];
            
            var supporting_tools = ["code_editors", "user_interface", 
                            "diagrams", "documentation", "communication", "collaboration"];
            
            var fields_exist = false;
            var count = 0;
            for (let i = 0; i < fields.length; i++) {
                if (localStorage.getItem(fields[i])) {
                    count++;
                }
            }
            if (count === fields.length) {
                fields_exist = true;
            }



            
            
            if (edit && !fields_exist) {
                localStorage.setItem("contact_tech-data-edit", JSON.stringify(api_data.user[0]));
                localStorage.setItem("contact_manager-data-edit", JSON.stringify(api_data.user[1]));
                localStorage.setItem("project-data-edit", JSON.stringify(api_data.details[0]));
                localStorage.setItem("stage-data-edit", JSON.stringify({"stage": api_data.stage}));
                localStorage.setItem("developed-data-edit", JSON.stringify(new_developed_data));
                localStorage.setItem("source_control-data-edit", JSON.stringify(new_source_control));
                localStorage.setItem("hosting-data-edit", JSON.stringify(api_data.architecture.hosting));
                localStorage.setItem("project_tracking-data-edit", JSON.stringify({"project_tracking": api_data.supporting_tools.project_tracking}));
                localStorage.setItem("incident_management-data-edit", JSON.stringify({"incident_management": api_data.supporting_tools.incident_management}));

                for (let i = 0; i < architecture.length; i++) {
                    var current = architecture[i];
                    if (i == 3) {
                        current = "integrations";
                    }
                    localStorage.setItem(current + "-data" + '-edit', JSON.stringify(api_data.architecture[architecture[i]]));
                }

                for (let i = 0; i < supporting_tools.length; i++) {
                    var current = supporting_tools[i];
                    localStorage.setItem(current + "-data" + '-edit', JSON.stringify(api_data.supporting_tools[current]));
                }
                }



        }

        function load_data() {
            // Reset error panel at the start
            clearErrors();
            if (edit){
                var original_data = "{{ project }}";
                original_data = original_data.replaceAll("&#39;", '"');
                original_data = JSON.parse(original_data);
                api_to_ui(original_data);
            }

            // Load all data from localStorage
            const storedData = {
                contactTech: localStorage.getItem(fields[0]),
                contactManager: localStorage.getItem(fields[1]),
                project: localStorage.getItem(fields[2]),
                developed: localStorage.getItem(fields[3]),
                stage: localStorage.getItem(fields[4]),
                sourceControl: localStorage.getItem(fields[5]),
                hosting: localStorage.getItem(fields[6]),
                database: localStorage.getItem(fields[7]),
                frameworks: localStorage.getItem(fields[8]),
                infrastructure: localStorage.getItem(fields[9]),
                integrations: localStorage.getItem(fields[10]),
                languages: localStorage.getItem(fields[11]),
                codeEditors: localStorage.getItem(fields[12]),
                userInterface: localStorage.getItem(fields[13]),
                diagrams: localStorage.getItem(fields[14]),
                projectTracking: localStorage.getItem(fields[15]),
                documentation: localStorage.getItem(fields[16]),
                communication: localStorage.getItem(fields[17]),
                collaboration: localStorage.getItem(fields[18]),
                incidentManagement: localStorage.getItem(fields[19])
            };


            // Process contacts
            const youData = processContacts(storedData.contactTech, storedData.contactManager);
            // Process all other sections
            const processedData = {
                sourceControl: processSourceControl(storedData.sourceControl),
                hosting: processHosting(storedData.hosting),
                database: validateData(storedData.database, 'Databases'),
                languages: validateData(storedData.languages, 'Languages'),
                frameworks: validateData(storedData.frameworks, 'Frameworks'),
                integrations: validateData(storedData.integrations, 'CI/CD'),
                infrastructure: validateData(storedData.infrastructure, 'Infrastructure'),
                project: validateData(storedData.project, 'Project', ['project_name', 'project_short_name', 'doc_link']),
                stage: validateData(storedData.stage, 'Stage', ['stage']),
                developed: validateData(storedData.developed, 'Developed', ['developed']),
                codeEditors: validateData(storedData.codeEditors, 'Code Editors'),
                userInterface: validateData(storedData.userInterface, 'User Interface'),
                diagrams: validateData(storedData.diagrams, 'Diagrams'),
                projectTracking: processProjectTracking(storedData.projectTracking),
                documentation: validateData(storedData.documentation, 'Documentation'),
                communication: validateData(storedData.communication, 'Communication'),
                collaboration: validateData(storedData.collaboration, 'Collaboration'),
                incidentManagement: processIncidentManagement(storedData.incidentManagement)
            };


            // Additional validation for hosting
            if (processedData.hosting) {
                if ((processedData.hosting.type === "Cloud" || processedData.hosting.type === "Hybrid") 
                    && (!processedData.hosting.others || processedData.hosting.others.length === 0)) {
                    displayError("'Hosting' section is incomplete");
                }
            }

            if (JSON.parse(localStorage.getItem('edit'))) { 

                var original_data = "{{ project }}";
                original_data = original_data.replaceAll("&#39;", '"');
                original_data = JSON.parse(original_data);
            }
            const finalData = {
                user: youData,
                details: processedData.project,
                developed: processedData.developed,
                source_control: [{
                    type: JSON.parse(storedData.sourceControl)?.source_control || '',
                    links: JSON.parse(storedData.sourceControl)?.links || []
                }],
                architecture: {
                    frameworks: processedData.frameworks || { main: [], others: [] },
                    infrastructure: processedData.infrastructure || { main: [], others: [] },
                    integrations: processedData.integrations || { main: [], others: [] },
                    languages: processedData.languages || { main: [], others: [] },
                    hosting: JSON.parse(storedData.hosting) || { type: '', others: [] },
                    database: processedData.database || { main: [], others: [] },
                },
                stage: processedData.stage?.stage || '',
                supporting_tools: {
                    code_editors: processedData.codeEditors || { main: [], others: [] },
                    user_interface: processedData.userInterface || { main: [], others: [] },
                    diagrams: processedData.diagrams || { main: [], others: [] },
                    project_tracking: processedData.projectTracking.project_tracking || '',
                    documentation: processedData.documentation || { main: [], others: [] },
                    communication: processedData.communication || { main: [], others: [] },
                    collaboration: processedData.collaboration || { main: [], others: [] },
                    incident_management: processedData.incidentManagement.incident_management || ''
                }
            };
            // Update the summary display
            updateSummaryDisplay(finalData);
            
            // Update hidden form fields
            updateHiddenFields(finalData);
        }


        function updateSummaryDisplay(finalData) {
            const summaryData = {
                technical_contact: finalData.user[0]?.email ? `${finalData.user[0].email} (${finalData.user[0].grade})` : '',
                delivery_manager: finalData.user[1]?.email ? `${finalData.user[1].email} (${finalData.user[1].grade})` : '',
                stage_details: finalData.stage ? `<ul><li>Stage: ${finalData.stage}</li></ul>` : '',
                project_details: finalData.details ? `<ul>
                    <li>Name: ${finalData.details.project_name}</li>
                    <li>Short Name: ${finalData.details.project_short_name}</li>
                    <li>Documentation Link: ${finalData.details.doc_link}</li>
                </ul>` : '',
                developed_details: finalData.developed ? `<ul>
                    <li>Developed By: ${finalData.developed.developed}</li>
                    <li>Partnership/Outsource Company: ${finalData.developed.partnership_company || finalData.developed.outsource_company || 'N/A'}</li>
                </ul>` : '',
                source_control_details: processSourceControl(localStorage.getItem(fields[5])),
                hosting_details: processHosting(localStorage.getItem(fields[6])),
                database_details: arrToList(finalData.architecture.database?.main?.concat(finalData.architecture.database?.others) || []),
                languages_details: arrToList(finalData.architecture.languages?.main?.concat(finalData.architecture.languages?.others) || []),
                framework_details: arrToList(finalData.architecture.frameworks?.main?.concat(finalData.architecture.frameworks?.others) || []),
                integration_details: arrToList(finalData.architecture.integrations?.main?.concat(finalData.architecture.integrations?.others) || []),
                infrastructure_details: arrToList(finalData.architecture.infrastructure?.main?.concat(finalData.architecture.infrastructure?.others) || []),
                code_editor_details: arrToList(finalData.supporting_tools.code_editors?.main?.concat(finalData.supporting_tools.code_editors?.others) || []),
                user_interface_details: arrToList(finalData.supporting_tools.user_interface?.main?.concat(finalData.supporting_tools.user_interface?.others) || []),
                diagram_details: arrToList(finalData.supporting_tools.diagrams?.main?.concat(finalData.supporting_tools.diagrams?.others) || []),
                project_tracking_details: finalData.supporting_tools.project_tracking,
                documentation_details: arrToList(finalData.supporting_tools.documentation?.main?.concat(finalData.supporting_tools.documentation?.others) || []),
                communication_details: arrToList(finalData.supporting_tools.communication?.main?.concat(finalData.supporting_tools.communication?.others) || []),
                collaboration_details: arrToList(finalData.supporting_tools.collaboration?.main?.concat(finalData.supporting_tools.collaboration?.others) || []),
                incident_management_details: finalData.supporting_tools.incident_management
            };
            // Update all summary elements
            Object.entries(summaryData).forEach(([key, value]) => {
                const element = document.getElementById(key);
                if (element) element.innerHTML = value;
            });
        }

        function updateHiddenFields(finalData) {
            var hiddenFields = {
                user: finalData.user,
                project: finalData.details,
                developed: finalData.developed,
                source_control: finalData.source_control,
                hosting: {
                    type: [finalData.architecture.hosting.type],
                    details: finalData.architecture.hosting.others
                },
                database: finalData.architecture.database,
                languages: finalData.architecture.languages,
                frameworks: finalData.architecture.frameworks,
                integrations: finalData.architecture.integrations,
                infrastructure: finalData.architecture.infrastructure,
                stage: finalData.stage,
                code_editors: finalData.supporting_tools.code_editors,
                user_interface: finalData.supporting_tools.user_interface,
                diagrams: finalData.supporting_tools.diagrams,
                project_tracking: finalData.supporting_tools.project_tracking,
                documentation: finalData.supporting_tools.documentation,
                communication: finalData.supporting_tools.communication,
                collaboration: finalData.supporting_tools.collaboration,
                incident_management: finalData.supporting_tools.incident_management
            };

            if (JSON.parse(localStorage.getItem('edit'))) {
                hiddenFields["project_name"] = "{{ project_name }}";
            }

            // Update all hidden input fields
            Object.entries(hiddenFields).forEach(([key, value]) => {
                const element = document.getElementById(key);
                if (element) element.value = JSON.stringify(value);
            });
        }


        // Initialize the page
        load_data();
        localStorage.setItem("source_control-validate", true);
        localStorage.setItem("hosting-validate", true);
    </script>


{% endblock %}
