{% extends "core.html" %}
{% from "components/summary/_macro.njk" import onsSummary %}
{% from "components/panel/_macro.njk" import onsPanel %}
{% from "components/label/_macro.njk" import onsLabel %}
{% from "components/button/_macro.njk" import onsButton %}
{% from "components/breadcrumbs/_macro.njk" import onsBreadcrumbs %}

{% block main %}
    {% call onsPanel({
        "id": "error-panel",
        "title": 'Error',
        "variant": 'error',
        "type": "error",
    }) %}


    {{ onsLabel({
        "id": 'label',
        "for": "some-input",
        "text": 'Please fill in missing data'
    }) }}
    {% endcall %}
    {% if edit %}
    {{ onsBreadcrumbs({
        "ariaLabel": 'Breadcrumbs',
        "itemsList": [
            {
                "url": url_for("view_project", project_name=project.details[0].name),
                "text": 'Back'
            },
        ],
    }) }}
    {% endif %}
    <h1 class="ons-u-mt-m">Check your answers</h1>
    {{ onsLabel({
        "id": 'label',
        "for": "some-input",
        "text": 'Please review the information you have entered before submitting the project.',
    }) }}
    {{ onsSummary({
            "variant": "hub",
            "classes": "ons-u-mt-m",
            "summaries": [
                {
                    "groups": [
                        {
                            "rows": [
                                {
                                    "rowTitle": "Technical Contact",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                                {
                                                    "text": "<div id='technical_contact'></div>"
                                                }
                                            ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change technical contact details",
                                                    "url": url_for('contact_tech'),
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Delivery Manager Contact",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                                {
                                                    "text": "<div id='delivery_manager'></div>"
                                                }
                                            ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change delivery manager details",
                                                    "url": url_for('contact_manager'),
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Project",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='project_details'></div>"
                                            }
                                        ],

                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change project details",
                                                    "url": url_for('project')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Developed",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='developed_details'></div>"
                                            }
                                        ],

                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change development status details",
                                                    "url": url_for('developed')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Stage",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='stage_details'></div>"
                                            }
                                        ],

                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change stage details",
                                                    "url": url_for('stage')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Source Control",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='source_control_details'></div>"
                                            }
                                        ],

                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change source control details",
                                                    "url": url_for('source_control')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Hosting",
                                    "rowItems": [
                                        {
                                        "valueList": [
                                            {
                                                "text": "<div id='hosting_details'></div>"
                                            }
                                        ],

                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change hosting details",
                                                    "url": url_for('hosting')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Database",
                                    "rowItems": [
                                        {
                                        "valueList": [
                                            {
                                                "text": "<div id='database_details'></div>"
                                            }
                                        ],

                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change database details",
                                                    "url": url_for('database')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Languages",
                                    "rowItems": [
                                        {
                                        "valueList": [
                                            {
                                                "text": "<div id='languages_details'></div>"
                                            }
                                        ],

                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change languages details",
                                                    "url": url_for('languages')                                              }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Frameworks",
                                    "rowItems": [
                                        {
                                        "valueList": [
                                            {
                                                "text": "<div id='framework_details'></div>"
                                            }
                                        ],

                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change frameworks details",
                                                    "url": url_for('frameworks')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "CI/CD",
                                    "rowItems": [
                                        {
                                        "valueList": [
                                            {
                                                "text": "<div id='integration_details'></div>"
                                            }
                                        ],
                              
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change integration details",
                                                    "url": url_for('integrations')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Infrastructure",
                                    "rowItems": [
                                        {   
                                        "valueList": [
                                            {
                                                "text": "<div id='infrastructure_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change infrastructure details",
                                                    "url": url_for('infrastructure')
                                                }
                                            ]
                                        }
                                    ]
                                },

                                {
                                    "rowTitle": "Code Editors",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                                {
                                                    "text": "<div id='code_editor_details'></div>"
                                                }
                                            ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change code editor details",
                                                    "url": url_for('code_editors'),
                                                }
                                            ]
                                        }
                                    ]
                                },

                                {
                                    "rowTitle": "User Interface",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='user_interface_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change user interface details",
                                                    "url": url_for('user_interface')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Diagrams",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='diagram_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change diagrams details",
                                                    "url": url_for('diagramming_tools')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Project Tracking",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='project_tracking_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change project tracking details",
                                                    "url": url_for('project_tracking')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Documentation",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='documentation_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change documentation details",
                                                    "url": url_for('documentation')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Communication",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='communication_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change communication details",
                                                    "url": url_for('communication')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Collaboration",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='collaboration_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change collaboration details",
                                                    "url": url_for('collaboration')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Incident Management",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='incident_management_details'></div>"
                                            }
                                        ],
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "Change incident management details",
                                                    "url": url_for('incident_management')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                
                                
                            ]
                        }
                    ]
                }
            ]
        }) }}
    <!--onsubmit="localStorage.clear()"-->
    <script src="{{ url_for('static', filename='utils.js') }}"></script>
    {% if edit %}
        <form action="{{ url_for('survey') }}" method="POST" onsubmit="removeEdits()">
    {% else %}
    <form action="{{ url_for('survey') }}" method="POST" onsubmit="localStorage.clear()">
    {% endif %}
      
    <input id="user" type="hidden" name="user">
    <input id="project" type="hidden" name="project">
    <input id="developed" type="hidden" name="developed">
    <input id="source_control" type="hidden" name="source_control">
    <input id="hosting" type="hidden" name="hosting">
    <input id="database" type="hidden" name="database">
    <input id="languages" type="hidden" name="languages">
    <input id="frameworks" type="hidden" name="frameworks">

    <input id="integrations" type="hidden" name="integrations">
    <input id="infrastructure" type="hidden" name="infrastructure">
    <input id="stage" type="hidden" name="stage">
    <input id="code_editors" type="hidden" name="code_editors">
    <input id="user_interface" type="hidden" name="user_interface">
    <input id="diagrams" type="hidden" name="diagrams">
    <input id="project_tracking" type="hidden" name="project_tracking">
    <input id="documentation" type="hidden" name="documentation">
    <input id="communication" type="hidden" name="communication">
    <input id="collaboration" type="hidden" name="collaboration">
    <input id="incident_management" type="hidden" name="incident_management">
    <input id="project_name" type="hidden" name="project_name">
    <input id="project_users" type="hidden" name="project_users">
      
    {{ onsButton({
            "text": 'Save Project',
            "id": "submit-button",
            "classes": 'ons-u-mb-m ons-u-mt-l',
            "iconType": "check",
            "iconPosition": "after",
        })
    }}
    
</form>
<script src="{{ url_for('static', filename='formScripts.js') }}"></script>
    <script>
            localStorage.setItem('redirect_url', window.location.href);
            var current_url = window.location.href.split("/");
            var trail = current_url[current_url.length - 1];
            var edit = false;
            if (trail === "edit") {
                edit = true;
            }
            localStorage.setItem("edit", edit)
            
            var fields = ['contact_tech-data', 'contact_manager-data', 'project-data', 'developed-data', 'stage-data', 
            'source_control-data', 'hosting-data', 'database-data', 'frameworks-data', 'infrastructure-data', 'integrations-data', 
            'languages-data', 'code_editors-data', 'user_interface-data', 'diagrams-data', 'project_tracking-data', 'documentation-data', 
            'communication-data', 'collaboration-data', 'incident_management-data'];

            if (edit) {
                for (let i = 0; i < fields.length; i++) {
                    fields[i] = fields[i] + '-edit'
                }
            }

        /**
         * Core utility functions for data processing
         */
        const DataUtils = {
            // Convert array to comma-separated list
            arrToList: function(arr) {
                if (!arr || arr.length === 0) return '';
                return arr.filter(item => item && item !== "").join(', ');
            },
            
            // Safely parse JSON with fallback
            safeJsonParse: function(jsonString, fallback = {}) {
                try {
                    return jsonString ? JSON.parse(jsonString) : fallback;
                } catch (e) {
                    console.error("JSON parse error:", e);
                    return fallback;
                }
            },
            
            // Safely get values with default fallbacks
            safeGet: function(obj, path, defaultValue = '') {
                if (!obj) return defaultValue;
                const parts = path.split('.');
                let current = obj;
                
                for (const part of parts) {
                    if (current[part] === undefined || current[part] === null) {
                        return defaultValue;
                    }
                    current = current[part];
                }
                
                return current;
            },
            
            // Combine main and other arrays
            combineArrays: function(obj, property) {
                if (!obj) return [];
                const main = obj[property]?.main || [];
                const others = obj[property]?.others || [];
                return [...main, ...others].filter(item => item && item !== "");
            }
        };
        
        /**
         * Error handling functions
         */
        const ErrorHandler = {
            // Display an error message
            displayError: function(message) {
                const errorPanel = document.getElementById('error-panel');
                errorPanel.style.display = 'block';
                
                let errorContainer = errorPanel.querySelector('.error-messages');
                if (!errorContainer) {
                    errorContainer = document.createElement('div');
                    errorContainer.className = 'error-messages';
                    const label = errorPanel.querySelector('label');
                    if (label) {
                        label.insertAdjacentElement('afterend', errorContainer);
                    } else {
                        errorPanel.appendChild(errorContainer);
                    }
                }
                
                errorContainer.innerHTML += `<ul><li>${message}</li></ul>`;
                document.getElementById('submit-button').style.display = 'none';
            },
            
            // Clear all errors
            clearErrors: function() {
                const errorPanel = document.getElementById('error-panel');
                errorPanel.style.display = 'none';
                const errorContainer = errorPanel.querySelector('.error-messages');
                if (errorContainer) {
                    errorContainer.innerHTML = '';
                }
                document.getElementById('submit-button').style.display = 'block';
            },
            
            // Validate data and display errors
            validateData: function(data, sectionName, requiredFields = []) {
                try {
                    const parsedData = typeof data === 'string' ? DataUtils.safeJsonParse(data) : data;
                    
                    for (const field of requiredFields) {
                        if (!parsedData[field] || parsedData[field] === "") {
                            const fieldName = field === 'name' ? 'Project Name' : field;
                            this.displayError(`'${sectionName}' section is missing required field: ${fieldName}`);
                        }
                    }
                    
                    return parsedData;
                } catch (e) {
                    this.displayError(`'${sectionName}' section is incomplete`);
                    return null;
                }
            }
        };

        function displayError(message) {
            ErrorHandler.displayError(message);
        }

        function clearErrors() {
            ErrorHandler.clearErrors();
        }

        function validateData(data, sectionName, requiredFields = []) {
            return ErrorHandler.validateData(data, sectionName, requiredFields);
        }

        function arrToList(arr) {
            return DataUtils.arrToList(arr);
        }

        /**
         * Data processors for specific sections
         */
        const DataProcessors = {
            processContacts: function(techData, managerData) {
                const contacts = [];
                
                // Process Technical Contact
                const techContact = DataUtils.safeJsonParse(techData);
                const managerContact = DataUtils.safeJsonParse(managerData);
                
                if ((!techContact || !techContact.contactEmail) && 
                    (!managerContact || !managerContact.contactEmail)) {
                    ErrorHandler.displayError("At least one contact (Technical Contact or Delivery Manager) is required");
                }
                
                // Add technical contact
                contacts.push({
                    email: techContact?.contactEmail || "",
                    roles: ["Technical Contact"],
                    grade: techContact?.role || ""
                });
                
                // Add delivery manager
                contacts.push({
                    email: managerContact?.contactEmail || "",
                    roles: ["Delivery Manager"],
                    grade: managerContact?.role || ""
                });
                
                return contacts;
            },
            
            processSourceControl: function(sourceControlData) {
                const data = DataUtils.safeJsonParse(sourceControlData);
                if (!data || !data.source_control) return '';
                
                let details = data.source_control;
                if (data.links && data.links.length > 0) {
                    data.links.forEach(link => {
                        if (link.description && link.url) {
                            details += `<br>${link.description}: ${link.url}`;
                        }
                    });
                }
                
                return details;
            },
            
            processHosting: function(hostingData) {
                const data = DataUtils.safeJsonParse(hostingData);
                if (!data || !data.type) return '';
                
                if (data.type === "On-premises") {
                    return "On-Premises";
                }
                
                const hostingValues = [];
                if (data.main && data.main.length) hostingValues.push(...data.main);
                if (data.others && data.others.length) hostingValues.push(...data.others);
                
                return DataUtils.arrToList(hostingValues);
            },
            
            processDeveloped: function(developedData) {
                const data = DataUtils.safeJsonParse(developedData);
                if (!data) return '';
                
                let result = '';
                if (data.developed) {
                    result += 'Developed: <p style="font-weight:400">' + data.developed + '</p>';
                    
                    if (data.developed === "Partnership" && data.partnership_company) {
                        result += `Partnership Company: <p style="font-weight:400">${data.partnership_company}</p>`;
                    } else if (data.developed === "Outsourced" && data.outsource_company) {
                        result += `Outsourced Company: <p style="font-weight:400">${data.outsource_company}</p>`;
                    }
                } else if (Array.isArray(data) && data.length > 0) {
                    // Handle old format
                    result += 'Developed: <p style="font-weight:400">' + data[0] + '</p>';
                    if ((data[0] === "Partnership" || data[0] === "Outsourced") && data[1] && data[1][0]) {
                        result += `${data[0]} Company: <p style="font-weight:400">${data[1][0]}</p>`;
                    }
                }
                
                return result;
            },
            
            processProjectDetails: function(projectData) {
                const data = DataUtils.safeJsonParse(projectData);
                if (!data) return '';
                
                let details = '';
                
                // Process for both API and form data formats
                const name = data.name || (data.details && data.details[0]?.name);
                const shortName = data.short_name || (data.details && data.details[0]?.short_name);
                const programmeName = data.programme_name || '';
                const programmeShortName = data.programme_short_name || '';
                const docLink = Array.isArray(data.documentation_link) ? 
                    data.documentation_link[0] : 
                    (data.details && data.details[0]?.documentation_link[0]);
                
                if (programmeName) {
                    details += 'Programme Name: <p style="font-weight:400">' + programmeName + '</p>';
                }
                if (programmeShortName) {
                    details += 'Programme Short Name: <p style="font-weight:400">' + programmeShortName + '</p>';
                }
                if (name) {
                    details += 'Project Name: <p style="font-weight:400">' + name + '</p>';
                }
                if (shortName) {
                    details += 'Short Name: <p style="font-weight:400">' + shortName + '</p>';
                }
                if (docLink) {
                    details += 'Documentation Link: <p style="font-weight:400">' + docLink + '</p>';
                }
                
                return details;
            }
        };

        // Maintain backward compatibility with existing function names
        function processSourceControl(sourceControlData) {
            return DataProcessors.processSourceControl(sourceControlData);
        }

        function processHosting(hostingData) {
            return DataProcessors.processHosting(hostingData);
        }

        function processContacts(techData, managerData) {
            return DataProcessors.processContacts(techData, managerData);
        }

        function processProjectTracking(projectTrackingData) {
            return DataUtils.safeJsonParse(projectTrackingData);
        }

        function processIncidentManagement(incidentManagementData) {
            return DataUtils.safeJsonParse(incidentManagementData);
        }

        /**
         * Data normalization and conversion
         */
        const DataNormalizer = {
            // Convert API format to consistent internal format
            normalizeApiData: function(apiData) {
                // Deep clone the original data to avoid modifying it
                const data = JSON.parse(JSON.stringify(apiData));
                
                // Extract additional users (non-technical contact, non-delivery manager)
                const additionalUsers = data.user.filter(user => 
                    !user.roles.includes('Technical Contact') && 
                    !user.roles.includes('Delivery Manager')
                );
                
                if (additionalUsers.length > 0) {
                    localStorage.setItem('additional_users-edit', JSON.stringify(additionalUsers));
                } else {
                    localStorage.removeItem('additional_users-edit');
                }
                
                // Transform contact data
                for (let i = 0; i < Math.min(2, data.user.length); i++) {
                    data.user[i].contactEmail = data.user[i].email;
                    data.user[i].role = data.user[i].grade;
                    delete data.user[i].email;
                    delete data.user[i].grade;
                    delete data.user[i].roles;
                }
                
                // Transform source control data
                const sourceControl = {
                    source_control: data.source_control[0]?.type || '',
                    links: data.source_control[0]?.links || []
                };
                
                // Transform hosting data
                const hosting = {
                    type: data.architecture.hosting.type[0] || '',
                    main: [],
                    others: data.architecture.hosting.details || []
                };
                
                // Prepare normalized data
                const normalizedData = {
                    contact_tech: data.user[0] || { contactEmail: '', role: '' },
                    contact_manager: data.user[1] || { contactEmail: '', role: '' },
                    project: data.details[0] || {},
                    developed: data.developed,
                    stage: { stage: data.stage },
                    source_control: sourceControl,
                    hosting: hosting,
                    database: data.architecture.database,
                    languages: data.architecture.languages,
                    frameworks: data.architecture.frameworks,
                    integrations: data.architecture.cicd,
                    infrastructure: data.architecture.infrastructure,
                    code_editors: data.supporting_tools.code_editors,
                    user_interface: data.supporting_tools.user_interface,
                    diagrams: data.supporting_tools.diagrams,
                    project_tracking: { project_tracking: data.supporting_tools.project_tracking },
                    documentation: data.supporting_tools.documentation,
                    communication: data.supporting_tools.communication,
                    collaboration: data.supporting_tools.collaboration,
                    incident_management: { incident_management: data.supporting_tools.incident_management }
                };
                
                return normalizedData;
            },
            
            // Save normalized data to localStorage
            saveToLocalStorage: function(normalizedData, isEdit) {
                const suffix = isEdit ? '-edit' : '';
                
                // Store each section in localStorage
                localStorage.setItem(`contact_tech-data${suffix}`, JSON.stringify(normalizedData.contact_tech));
                localStorage.setItem(`contact_manager-data${suffix}`, JSON.stringify(normalizedData.contact_manager));
                localStorage.setItem(`project-data${suffix}`, JSON.stringify(normalizedData.project));
                localStorage.setItem(`stage-data${suffix}`, JSON.stringify(normalizedData.stage));
                localStorage.setItem(`developed-data${suffix}`, JSON.stringify(normalizedData.developed));
                localStorage.setItem(`source_control-data${suffix}`, JSON.stringify(normalizedData.source_control));
                localStorage.setItem(`hosting-data${suffix}`, JSON.stringify(normalizedData.hosting));
                localStorage.setItem(`database-data${suffix}`, JSON.stringify(normalizedData.database));
                localStorage.setItem(`languages-data${suffix}`, JSON.stringify(normalizedData.languages));
                localStorage.setItem(`frameworks-data${suffix}`, JSON.stringify(normalizedData.frameworks));
                localStorage.setItem(`integrations-data${suffix}`, JSON.stringify(normalizedData.integrations));
                localStorage.setItem(`infrastructure-data${suffix}`, JSON.stringify(normalizedData.infrastructure));
                localStorage.setItem(`code_editors-data${suffix}`, JSON.stringify(normalizedData.code_editors));
                localStorage.setItem(`user_interface-data${suffix}`, JSON.stringify(normalizedData.user_interface));
                localStorage.setItem(`diagrams-data${suffix}`, JSON.stringify(normalizedData.diagrams));
                localStorage.setItem(`project_tracking-data${suffix}`, JSON.stringify(normalizedData.project_tracking));
                localStorage.setItem(`documentation-data${suffix}`, JSON.stringify(normalizedData.documentation));
                localStorage.setItem(`communication-data${suffix}`, JSON.stringify(normalizedData.communication));
                localStorage.setItem(`collaboration-data${suffix}`, JSON.stringify(normalizedData.collaboration));
                localStorage.setItem(`incident_management-data${suffix}`, JSON.stringify(normalizedData.incident_management));
            },
            
            // Create API format data from processed data
            createApiFormat: function(processedData) {
                // Extract users and add any additional users from previous edit
                const additionalUsers = DataUtils.safeJsonParse(localStorage.getItem('additional_users-edit') || '[]');
                
                // Construct the final data format
                const finalData = {
                    user: processedData.user || [],
                    details: processedData.project || {},
                    developed: processedData.developed || {},
                    source_control: [{
                        type: processedData.source_control?.source_control || '',
                        links: processedData.source_control?.links || []
                    }],
                    architecture: {
                        frameworks: processedData.frameworks || { main: [], others: [] },
                        infrastructure: processedData.infrastructure || { main: [], others: [] },
                        integrations: processedData.integrations || { main: [], others: [] },
                        languages: processedData.languages || { main: [], others: [] },
                        hosting: {
                            type: Array.isArray(processedData.hosting?.type) ? 
                                processedData.hosting.type : 
                                [processedData.hosting?.type || ''],
                            details: processedData.hosting?.others || []
                        },
                        database: processedData.database || { main: [], others: [] },
                    },
                    stage: processedData.stage?.stage || '',
                    supporting_tools: {
                        code_editors: processedData.code_editors || { main: [], others: [] },
                        user_interface: processedData.user_interface || { main: [], others: [] },
                        diagrams: processedData.diagrams || { main: [], others: [] },
                        project_tracking: processedData.project_tracking?.project_tracking || '',
                        documentation: processedData.documentation || { main: [], others: [] },
                        communication: processedData.communication || { main: [], others: [] },
                        collaboration: processedData.collaboration || { main: [], others: [] },
                        incident_management: processedData.incident_management?.incident_management || ''
                    }
                };
                
                // Add edit-specific properties
                if (JSON.parse(localStorage.getItem('edit'))) {
                    finalData.project_name = "{{ project_name }}";
                    if (additionalUsers.length > 0) {
                        finalData.project_users = [...processedData.user, ...additionalUsers];
                    } else {
                        finalData.project_users = processedData.user;
                    }
                }
                
                return finalData;
            }
        };

        /**
         * UI Update functions
         */
        const UIUpdater = {
            // Update the summary display with processed data
            updateSummaryDisplay: function(data) {
                // Create summary data object with formatted values
                const summaryData = {
                    technical_contact: data.user[0]?.email ? 
                        `${data.user[0].email} (${data.user[0].grade || ''})` : '',
                    delivery_manager: data.user[1]?.email ? 
                        `${data.user[1].email} (${data.user[1].grade || ''})` : '',
                    stage_details: data.stage || '',
                    project_details: DataProcessors.processProjectDetails(JSON.stringify({
                        name: data.details.name,
                        short_name: data.details.short_name,
                        programme_name: data.details.programme_name,
                        programme_short_name: data.details.programme_short_name,
                        documentation_link: data.details.documentation_link
                    })),
                    developed_details: DataProcessors.processDeveloped(JSON.stringify(data.developed)),
                    source_control_details: data.source_control[0]?.type ? 
                        `${data.source_control[0].type}${data.source_control[0].links.map(link => 
                            `<br>${link.description}: ${link.url}`).join('')}` : '',
                    hosting_details: data.architecture.hosting.type ? 
                        (data.architecture.hosting.type[0] === "On-premises" ? "On-Premises" : 
                            DataUtils.arrToList(data.architecture.hosting.details)) : '',
                    database_details: DataUtils.arrToList([
                        ...DataUtils.safeGet(data.architecture.database, 'main', []), 
                        ...DataUtils.safeGet(data.architecture.database, 'others', [])
                    ]),
                    languages_details: DataUtils.arrToList([
                        ...DataUtils.safeGet(data.architecture.languages, 'main', []), 
                        ...DataUtils.safeGet(data.architecture.languages, 'others', [])
                    ]),
                    framework_details: DataUtils.arrToList([
                        ...DataUtils.safeGet(data.architecture.frameworks, 'main', []), 
                        ...DataUtils.safeGet(data.architecture.frameworks, 'others', [])
                    ]),
                    integration_details: DataUtils.arrToList([
                        ...DataUtils.safeGet(data.architecture.integrations, 'main', []), 
                        ...DataUtils.safeGet(data.architecture.integrations, 'others', [])
                    ]),
                    infrastructure_details: DataUtils.arrToList([
                        ...DataUtils.safeGet(data.architecture.infrastructure, 'main', []), 
                        ...DataUtils.safeGet(data.architecture.infrastructure, 'others', [])
                    ]),
                    code_editor_details: DataUtils.arrToList([
                        ...DataUtils.safeGet(data.supporting_tools.code_editors, 'main', []), 
                        ...DataUtils.safeGet(data.supporting_tools.code_editors, 'others', [])
                    ]),
                    user_interface_details: DataUtils.arrToList([
                        ...DataUtils.safeGet(data.supporting_tools.user_interface, 'main', []), 
                        ...DataUtils.safeGet(data.supporting_tools.user_interface, 'others', [])
                    ]),
                    diagram_details: DataUtils.arrToList([
                        ...DataUtils.safeGet(data.supporting_tools.diagrams, 'main', []), 
                        ...DataUtils.safeGet(data.supporting_tools.diagrams, 'others', [])
                    ]),
                    project_tracking_details: data.supporting_tools.project_tracking || '',
                    documentation_details: DataUtils.arrToList([
                        ...DataUtils.safeGet(data.supporting_tools.documentation, 'main', []), 
                        ...DataUtils.safeGet(data.supporting_tools.documentation, 'others', [])
                    ]),
                    communication_details: DataUtils.arrToList([
                        ...DataUtils.safeGet(data.supporting_tools.communication, 'main', []), 
                        ...DataUtils.safeGet(data.supporting_tools.communication, 'others', [])
                    ]),
                    collaboration_details: DataUtils.arrToList([
                        ...DataUtils.safeGet(data.supporting_tools.collaboration, 'main', []), 
                        ...DataUtils.safeGet(data.supporting_tools.collaboration, 'others', [])
                    ]),
                    incident_management_details: data.supporting_tools.incident_management || ''
                };
                
                // Update all summary elements
                Object.entries(summaryData).forEach(([key, value]) => {
                    const element = document.getElementById(key);
                    if (element) element.innerHTML = value;
                });
            },
            
            // Update the hidden form fields for submission
            updateHiddenFields: function(data) {
                // Map data to form fields
                const hiddenFields = {
                    user: data.user,
                    project: data.details,
                    developed: data.developed,
                    source_control: data.source_control,
                    hosting: {
                        type: Array.isArray(data.architecture.hosting.type) ? 
                            data.architecture.hosting.type : 
                            [data.architecture.hosting.type],
                        details: data.architecture.hosting.details
                    },
                    database: data.architecture.database,
                    languages: data.architecture.languages,
                    frameworks: data.architecture.frameworks,
                    integrations: data.architecture.integrations,
                    infrastructure: data.architecture.infrastructure,
                    stage: data.stage,
                    code_editors: data.supporting_tools.code_editors,
                    user_interface: data.supporting_tools.user_interface,
                    diagrams: data.supporting_tools.diagrams,
                    project_tracking: data.supporting_tools.project_tracking,
                    documentation: data.supporting_tools.documentation,
                    communication: data.supporting_tools.communication,
                    collaboration: data.supporting_tools.collaboration,
                    incident_management: data.supporting_tools.incident_management
                };
                
                // For edit mode, add project name and users
                if (data.project_name) {
                    hiddenFields.project_name = data.project_name;
                }
                
                if (data.project_users) {
                    hiddenFields.project_users = data.project_users;
                }
                
                // Update all hidden input fields
                Object.entries(hiddenFields).forEach(([key, value]) => {
                    const element = document.getElementById(key);
                    if (element) element.value = JSON.stringify(value);
                });
            }
        };
        
        /**
         * Main application controller
         */
        const AppController = {
            // Get field mapping for localStorage keys
            getFields: function(isEdit) {
                const suffix = isEdit ? '-edit' : '';
                return [
                    `contact_tech-data${suffix}`, `contact_manager-data${suffix}`, `project-data${suffix}`, 
                    `developed-data${suffix}`, `stage-data${suffix}`, `source_control-data${suffix}`, 
                    `hosting-data${suffix}`, `database-data${suffix}`, `frameworks-data${suffix}`, 
                    `infrastructure-data${suffix}`, `integrations-data${suffix}`, `languages-data${suffix}`, 
                    `code_editors-data${suffix}`, `user_interface-data${suffix}`, `diagrams-data${suffix}`, 
                    `project_tracking-data${suffix}`, `documentation-data${suffix}`, `communication-data${suffix}`, 
                    `collaboration-data${suffix}`, `incident_management-data${suffix}`
                ];
            },
            
            // Load data from API or localStorage
            loadData: function() {
                // Reset error panel at start
                ErrorHandler.clearErrors();
                
                const isEdit = JSON.parse(localStorage.getItem('edit') || 'false');
                const fieldKeys = this.getFields(isEdit);
                
                // If in edit mode, load original data from server
                if (isEdit) {
                    try {
                        let originalData = "{{ project }}";
                        originalData = originalData.replaceAll("&#39;", '"');
                        originalData = originalData.replace(/\[None\]/g, '["N/A"]');
                        originalData = originalData.replace(/: None(?!\])/g, ': ""');
                        originalData = JSON.parse(originalData);
                        
                        // Store the original data
                        localStorage.setItem("original_data", JSON.stringify(originalData));
                        
                        // Check if we already have processed this data in localStorage
                        let fieldsExist = fieldKeys.every(key => localStorage.getItem(key));
                        
                        // If not all fields exist in localStorage, normalize and save API data
                        if (!fieldsExist) {
                            const normalizedData = DataNormalizer.normalizeApiData(originalData);
                            DataNormalizer.saveToLocalStorage(normalizedData, true);
                        }
                    } catch (e) {
                        console.error("Error processing original data:", e);
                    }
                }
                
                // Load data from localStorage
                const storedData = {
                    contactTech: localStorage.getItem(fieldKeys[0]),
                    contactManager: localStorage.getItem(fieldKeys[1]),
                    project: localStorage.getItem(fieldKeys[2]),
                    developed: localStorage.getItem(fieldKeys[3]),
                    stage: localStorage.getItem(fieldKeys[4]),
                    sourceControl: localStorage.getItem(fieldKeys[5]),
                    hosting: localStorage.getItem(fieldKeys[6]),
                    database: localStorage.getItem(fieldKeys[7]),
                    frameworks: localStorage.getItem(fieldKeys[8]),
                    infrastructure: localStorage.getItem(fieldKeys[9]),
                    integrations: localStorage.getItem(fieldKeys[10]),
                    languages: localStorage.getItem(fieldKeys[11]),
                    codeEditors: localStorage.getItem(fieldKeys[12]),
                    userInterface: localStorage.getItem(fieldKeys[13]),
                    diagrams: localStorage.getItem(fieldKeys[14]),
                    projectTracking: localStorage.getItem(fieldKeys[15]),
                    documentation: localStorage.getItem(fieldKeys[16]),
                    communication: localStorage.getItem(fieldKeys[17]),
                    collaboration: localStorage.getItem(fieldKeys[18]),
                    incidentManagement: localStorage.getItem(fieldKeys[19])
                };
                
                // Process and validate data
                const processedData = {
                    user: DataProcessors.processContacts(storedData.contactTech, storedData.contactManager),
                    project: ErrorHandler.validateData(storedData.project, 'Project', ['name']),
                    developed: ErrorHandler.validateData(storedData.developed, 'Developed'),
                    stage: ErrorHandler.validateData(storedData.stage, 'Stage'),
                    source_control: DataUtils.safeJsonParse(storedData.sourceControl),
                    hosting: DataUtils.safeJsonParse(storedData.hosting),
                    database: ErrorHandler.validateData(storedData.database, 'Databases'),
                    languages: ErrorHandler.validateData(storedData.languages, 'Languages'),
                    frameworks: ErrorHandler.validateData(storedData.frameworks, 'Frameworks'),
                    integrations: ErrorHandler.validateData(storedData.integrations, 'CI/CD'),
                    infrastructure: ErrorHandler.validateData(storedData.infrastructure, 'Infrastructure'),
                    code_editors: ErrorHandler.validateData(storedData.codeEditors, 'Code Editors'),
                    user_interface: ErrorHandler.validateData(storedData.userInterface, 'User Interface'),
                    diagrams: ErrorHandler.validateData(storedData.diagrams, 'Diagrams'),
                    project_tracking: DataUtils.safeJsonParse(storedData.projectTracking),
                    documentation: ErrorHandler.validateData(storedData.documentation, 'Documentation'),
                    communication: ErrorHandler.validateData(storedData.communication, 'Communication'),
                    collaboration: ErrorHandler.validateData(storedData.collaboration, 'Collaboration'),
                    incident_management: DataUtils.safeJsonParse(storedData.incidentManagement)
                };
                
                // If in edit mode and we didn't get valid data from localStorage, fallback to original data
                if (isEdit && (!processedData.project || !processedData.project.name)) {
                    try {
                        let originalData = JSON.parse(localStorage.getItem("original_data") || "{}");
                        if (originalData && originalData.details && originalData.details[0]) {
                            processedData.project = originalData.details[0];
                        }
                    } catch (e) {
                        console.error("Error using fallback data:", e);
                    }
                }
                
                // Convert to final API format
                const finalData = DataNormalizer.createApiFormat(processedData);
                
                // Update UI with processed data
                UIUpdater.updateSummaryDisplay(finalData);
                UIUpdater.updateHiddenFields(finalData);
            },
            
            // Initialize the app
            init: function() {
                this.loadData();
                
                // Setup validation flags
                localStorage.setItem("source_control-validate", true);
                localStorage.setItem("hosting-validate", true);
            }
        };
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            AppController.init();
        });

        // Legacy function for backward compatibility
        function api_to_ui(api_data) {
            const normalizedData = DataNormalizer.normalizeApiData(api_data);
            DataNormalizer.saveToLocalStorage(normalizedData, true);
        }
        
        // Legacy function for backward compatibility
        function load_data() {
            AppController.loadData();
        }
        
        function removeEdits() {
            const isEdit = JSON.parse(localStorage.getItem('edit') || 'false');
            if (isEdit) {
                const fieldKeys = AppController.getFields(true);
                fieldKeys.forEach(key => localStorage.removeItem(key));
                localStorage.removeItem('additional_users-edit');
            }
        }
    </script>


{% endblock %}
