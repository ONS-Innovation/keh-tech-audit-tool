{% extends "layout/_template.njk" %}
{% from "components/summary/_macro.njk" import onsSummary %}
{% from "components/button/_macro.njk" import onsButton %}
{% set pageConfig = {
        "header": {
            "title": "Create a project",
            "signoutButton": {
                "text": "Save and sign out"
            }
        },
        "breadcrumbs": {
            "itemsList": [
                            {
                    "url": '/dashboard#add-projects',
                    "text": 'Dashboard'
                },
                {
                    "url": '/pre-survey',
                    "text": 'Pre-survey'
                }
            ]
        },
              "footer": {
          "OGLLink": {
              "pre": "All content is available under the", "link": "Open Government Licence v3.0",
              "url": "https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/",
              "post": ", except where otherwise stated"
          }
      }
    } %}
{% macro checkBox() %}
    check
{%- endmacro %}
{% block main %}
    <h1 class="ons-u-mt-m">Choose another section to complete</h1>
    {{ onsSummary({
            "variant": "hub",
            "classes": "ons-u-mt-m",
            "summaries": [
                {
                    "groups": [
                        {
                            "rows": [
                                {
                                    "rowTitle": "Project Details",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                                {
                                                    "text": "<div id='user_details'></div>"
                                                }
                                            ],
                                          "id": "user-details",

                                            "iconType": "none",
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for People who live here",
                                                    "url": url_for('project_pre_survey'),
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Code and Architecture",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='project_details'></div>"
                                            }
                                        ],
                                        "id": "project-details",
                                            "iconType": "none", 
                                            "actions": [
                                                {   
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for Household accommodation",
                                                    "url": url_for('architecture_pre_survey')
                                                }
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "rowTitle": "Technology Details",
                                    "rowItems": [
                                        {
                                            "valueList": [
                                            {
                                                "text": "<div id='developed_details'></div>"
                                            }
                                        ],
                                        "id": "developed-details",
                                            "iconType": "none",
                                            "actions": [
                                                {
                                                    "text": "Change",
                                                    "ariaLabel": "View answers for Mary Smith",
                                                    "url": url_for('tech_pre_survey')
                                                }
                                            ]
                                        }
                                    ]
                                },
                            ]
                        }
                    ]
                }
            ]
        }) }}
    {{ onsButton({
            "text": 'Continue to Submission',
            "classes": 'ons-u-mb-m ons-u-mt-l',
            "url": url_for('validate_details')
        }) }}
    <script>
        function load_data() {
            // Project Details
            var contactTechData = localStorage.getItem('contact-tech-data');
            var contactManagerData = localStorage.getItem('contact-manager-data');
            var projectData = localStorage.getItem('data');
            var developedData = localStorage.getItem('data-developed');

            // Architecture Details 
            var sourceControlData = localStorage.getItem('data-source-control');
            var architectureData = localStorage.getItem('architecture-data');
            var databaseData = localStorage.getItem('data-database');

            // Technology Details
            var frameworksData = localStorage.getItem('frameworks-data');
            var infrastructureData = localStorage.getItem('infrastructure-data');
            var integrationsData = localStorage.getItem('integrations-data');
            var languagesData = localStorage.getItem('languages-data');

            function updateSectionStatus(sectionId, dataItems) {
                var sectionElement = document.getElementById(sectionId);
                if (sectionElement) {
                    var completedCount = dataItems.filter(item => item && JSON.parse(item).complete).length;
                    var totalCount = dataItems.length;

                    var sectionIdWithDash = sectionId.replace(/_/g, '-');
                    var sectionElementWithDash = document.getElementById(sectionIdWithDash);
                    var actionSpan = sectionElementWithDash.querySelectorAll('dd span')[1];

                    if (completedCount === 0) {
                        sectionElement.innerHTML = 'Not Started';
                        if (actionSpan) {
                            actionSpan.innerHTML = 'Start section';
                        }
                    } else if (completedCount < totalCount) {
                        sectionElement.innerHTML = 'Partially completed';
                        if (actionSpan) {
                            actionSpan.innerHTML = 'Continue with section';
                        }
                    } else {
                        sectionElement.innerHTML = 'Completed';
                        if (actionSpan) {
                            actionSpan.textContent = 'Change section';
                        }
                        var span = sectionElementWithDash.querySelector('dt span');
                        if (span) {
                            span.innerHTML = '<span class="ons-summary__item-title-icon ons-summary__item-title-icon--check"><svg class="ons-icon" viewBox="0 0 13 10"' +
                                ' xmlns="http://www.w3.org/2000/svg" focusable="false" fill="currentColor"> <path d="M14.35,3.9l-.71-.71a.5.5,0,0,0-.71,0' +
                                'h0L5.79,10.34,3.07,7.61a.51.51,0,0,0-.71,0l-.71.71a.51.51,0,0,0,0,.71l3.78,3.78a.5.5,0,0,0,.71,0h0L14.35,4.6A.5.5,0,0,0,' +
                                '14.35,3.9Z" transform="translate(-1.51 -3.04)"></path> </svg></span>';
                        }
                    }
                }
            }

            updateSectionStatus('user_details', [contactTechData, contactManagerData, projectData, developedData]);
            updateSectionStatus('project_details', [sourceControlData, architectureData, databaseData]);
            updateSectionStatus('developed_details', [frameworksData, infrastructureData, integrationsData, languagesData]);
        }
        load_data();
    </script>
{% endblock %}
{% block scripts %}
    <style>
        body {
            height: auto;
        }
    </style>
{% endblock %}